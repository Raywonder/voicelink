Bug reports for VoiceLink,
02-05-26
Platform
Macos
Using Voiceover Screen Reader
Making sure to keep all rules from systemrules.md in root of dev/ and other files mentioned in document in tact, this is what needs to be done.
Also add to the bug tracker on voicelink.devinecreations.net/bugtracker
Build a native windows installer as well if possible and fix and upload to pages and replace older windows versions with proper 1.0 build. Make sure to use latest versions of all Swift and other apis and coding langwages.
1, When joining rooms, user that joins ends up in room more then once, also messages are duplicated.
2, Only message send sound is playing, not joining and leaving sounds. Also click sounds are not playing when mute or unmute and Defin buttons are pressed, needs more proper descriptions of what the buttons do next to labels. Also proper announcements of states of mute and unmute for input and output. Renaming to Microphone or input mute and output mute button label is best.
2.1, Creating rooms in app does not work in desktopp app, doe snot connect to api and create room and should show and use all room times available if authenticated properly and for guest user not logged in.
Also Guests should be able to set a name, and logged-in users should display their Mastodon display name by default if configured in profile of mastodon. First name, last name, nickname or display name.
3, Actions that are set for when focused on rooms, and users when in rooms are not accessible in UI that are used for performing tasks. On rooms or users when in rooms, such as sharing a room, or types of actions on user when in rooms and focused, like whisper, direct message, send file. etc. All features from the web app should be in the desktop app for both Windows and Mac builds.
4., When whisper feature is enabled, holding down enter key and feature is enabled, whisper is used, and when key is no longer being held down, it deactivates. For iOS, would be double tap and hold and release when done. Proper FX should play.
5, Messages are not clearing in desktop client when changing rooms.
 Messages should only stay in rooms they are sent and received in.
6, If accessing settings tab in app, user is kicked out of room. Some times happens when switching to another app then returning causing user to re join and become a duplicate user.
7. Frontend web app client should be fixed so it’s accessible via Chrome and Safari browsers and not just desktop app.
8, All fixes should be pushed to current 1.0 installed app that is connected to api, giving also time for testing auto-update patch features.
Otherwise if not working, rebuild and with all features include working version with updater using the download checksums generated.
9, Update checker should be in first menu where settings option is for app, not in help menu, and only should be one help menu not two.
10, Including the sound test option in the audio settings tab after user changes out put devices should play the ‘your-sound-test.wav’ file in the assets/sounds folder. Button titled, Sound Test, or test my sound. If pressed once, plays, if pressed again, stops. Do not overlap playback and do not loop.
11, Completing the copy party backend and client desktop app connection if possible should be done as well, seamless in client for use and pasting files in chat box if not using file transfer option for user or channel in menu is used should also work. Files are stored on mastodon instances if loge din and storing is possible, respects how mastodon hosts files. Fallback is storage paths on server and final is direct to each user via client p2p. Feature is not used in web app, hidden from web app users. Chatting is allowed but rate limited in web app to prevent spam, unless logedin and authenticated.
---
FIXES APPLIED (2026-02-06)
- Added WHMCS auth endpoints (login/session/logout/SSO) and Ecripto login endpoints in server routes.
- Updated WHMCS API URL default to https://devine-creations.com/includes/api.php and Ecripto API URL to https://api.ecripto.app.
- Web client login UI: tabs (Client Portal, Mastodon default, Wallet), added 2FA + mastodon handle fields, removed local register, added portal login button.
- Removed Electron references from web client JS (moved to nativeAPI/openExternal).
- Added bug tracker page under /bugtracker.
- Swift native: added WHMCS auth flow + login UI with 2FA and portal login button.
- Swift native: added Community Server support + menu quick connect; Sync filter includes Main Server / Community Server.
- Updated Connection Health to include Community Server checks.
- Added Connection Settings dropdown in Settings (preferred connection) and auto-connect/reconnect toggles.
- Moved nickname input out of main UI (now in Settings → Profile); added Room menu item “Set Nickname…” to open Profile tab.
- Updated downloads links to https://voicelink.devinecreations.net/downloads/VoiceLink-macOS.zip.
- Built new macOS zip, uploaded to /home/devinecr/downloads/voicelink/ and updated latest-mac.yml checksum/size.
- Synced client + source to main server and VPS, restarted pm2 on both.
- Fixed module registry loading to prevent undefined modules config (two-factor-auth error).
- Restarted TeamTalk services; WaltersPlace failed due to port 10333 already in use (needs port change or stop conflict).

NOTES / PENDING
- GitHub push failing from this machine due to DNS (github.com not resolving).
- App launch on this Mac shows kLSNoExecutableErr (environment limitation suspected) despite VoiceLink binary present.
- WaltersPlace TeamTalk instance needs port conflict resolved (10333 in use by DevineCreations).
- Keychain password update must be done locally by user (cannot accept/store passwords in chat).

CLAUDE TASKS (PENDING)
- Investigate macOS launch error: kLSNoExecutableErr even when VoiceLink binary exists; suggest root cause and fix.
- Review auto-update flow; propose best method to force update prompt without bumping version.
- Review UI placement for nickname (menu-only) and suggest any UX improvements.
- Validate WHMCS + Mastodon auth flows for native macOS app; suggest edge cases.
- Review TeamTalk WaltersPlace port conflict (10333) and propose safe port reassignment.

CLAUDE TASKS (ADD)
- Investigate Headscale/Tailscale network blocking external access; verify ACLs, exit nodes, subnet routes, and UFW/iptables interactions. Confirm services reachable from outside network.
If complete, make sure audio is working in both web app and Desktop app workflow seamlessly, currently no audio works on either for microphone input and audio output of users. Duplicate users still show when joining a room and button labeling next to users in room list should be titled Audiocontrols for username... hide or show. Moving to action menu under each user can save space as well. 
2026-02-06
Claude task, Verify that the following is true.
- Added multi-device session tracking on server (register-session, multi-device-login, multi-device-command) in both source and server routes.
- Swift app now registers sessions on connect and handles multi-device actions; added Connections settings tab with multi-device behavior selector.
- pm2: fixed ecripto-api EADDRINUSE by killing rogue node and restarting pm2; ecripto-api now online.
- Web client: added Connections settings tab and multi-device session handling (auto-quit, reconnect/exit actions).
- WHMCS login now emits entitlements (device tier/max devices/multi-device allowances) when config options/custom fields are present.
- Web client hides Connections tab unless entitlements allow multi-device settings.
- Free tier rooms: max 5 users, public only, non-persistent (duration clamped to 30 minutes).

[2026-02-06] WHMCS: fixed flexpbx admin widget class reference (Widget -> Module\Widget); created missing tblusers/tblusers_clients mapping for client id 9 to resolve isEmailVerificationEnabled() null; removed self-require in mastodon-frontend.php causing getInstanceDir redeclare.

[2026-02-06] macOS app: window close now hides to menubar and can re-open; resources bundled via SwiftPM so UI sounds should play; app bundle and updater zip rebuilt.

[2026-02-06] macOS app: added Updates tab inside Settings (uses UpdateSettingsView) so update options live in Settings.

[2026-02-06] macOS app: added per-user volume/mute controls in room list, User Audio Controls panel, and Solo toggle; wired user volume/mute/solo to SpatialAudioEngine mixer volumes.

---
[2026-02-06 PM] - Claude Session Completed

FEATURES IMPLEMENTED:
1. Profile Settings Tab
   - Added new Profile tab to Settings with nickname input field
   - Nickname stored in UserDefaults and persisted across sessions
   - Added "Set Nickname..." menu item in Account menu (Cmd+I)
   - Notification-based system to open Settings -> Profile tab
   - File: VoiceLinkApp.swift lines 1500-1641, 1723-1869

2. UI Settings
   - Added "Show Audio Controls on Startup" toggle in Audio settings
   - Setting persisted in UserDefaults
   - File: VoiceLinkApp.swift lines 1557, 1619, 1925-1930

3. Sound Test Feature
   - Added sound test button in Audio Settings -> Output Device section
   - Plays/stops yoursoundtest.wav file
   - Button toggles between "Test My Sound" and "Stop Test"
   - File: AppSoundManager.swift (added soundTest case, stopSound and isSoundPlaying methods)
   - File: VoiceLinkApp.swift lines 1912-1922

4. Check for Updates Relocation
   - Moved "Check for Updates..." from Help menu to menu bar status menu
   - Now appears after "Open VoiceLink" button
   - File: MenuBarServer.swift lines 264-267
   - File: VoiceLinkApp.swift (removed from Help menu)

BUILD & DEPLOYMENT:
- Built release version: swift build -c release (80.40s)
- Created VoiceLink-macOS.zip (153,494,297 bytes)
- SHA512: 1efa7a6a4dfb3b8f07866d1932fb9f346e88d9010ef46b0d11cd16b280c29942a25255255a101a97ee167213809dad57f2a397103c2e5d14b2aff81f3c66270f
- Base64: Hvp6ak37O48Hhm0ZMvufNG6I2QEO9GsNEc0WsoDCmUKiUlUlWhAal+4WchOAna1X8qOXEDwuXRSyr/gfPGYnDw==
- Uploaded to both servers:
  - Main: 64.20.46.178:/home/devinecr/downloads/voicelink/
  - VPS: 208.73.204.162:/home/devinecr/downloads/voicelink/
- Updated latest-mac.yml with new checksum, size, and release notes

FILES MODIFIED:
- /Users/admin/DEV/APPS/VOICELINK-LOCAL/swift-native/VoiceLinkNative/Sources/VoiceLinkApp.swift
  - Added Profile settings tab and view
  - Added nickname property to SettingsManager
  - Added showAudioControlsOnStartup property
  - Added sound test button
  - Added notification receiver for opening profile settings
  - Removed "Check for Updates" from Help menu
- /Users/admin/DEV/APPS/VOICELINK-LOCAL/swift-native/VoiceLinkNative/Sources/MenuBarServer.swift
  - Added "Check for Updates..." button to menu bar
- /Users/admin/DEV/APPS/VOICELINK-LOCAL/swift-native/VoiceLinkNative/Sources/AppSoundManager.swift
  - Added soundTest enum case (yoursoundtest.wav)
  - Added stopSound() method
  - Added isSoundPlaying() method

TESTING NOTES:
- Sound test button requires yoursoundtest.wav in Resources/sounds/
- Profile nickname field saves on change
- Cmd+I keyboard shortcut opens Settings -> Profile tab
- Check for Updates accessible from menu bar

---
[2026-02-06 PM Build 2] - Critical Fixes Applied

ISSUES RESOLVED:
1. Per-User Audio Controls Restored
   - Added expandable audio controls to UserRow
   - Volume slider (0-100%), Mute toggle, Solo toggle for each user
   - Chevron button to expand/collapse controls
   - File: VoiceLinkApp.swift UserRow struct

2. Sound Test Fixed
   - Copied your-sound-test.wav to Resources/sounds/
   - Fixed filename in AppSoundManager.swift (was yoursoundtest, now your-sound-test)
   - Added @State variable for button label updates
   - File: AppSoundManager.swift, VoiceLinkApp.swift audioSettings

3. Mastodon Display Enhanced
   - Changed from two lines ("Logged in as: displayName" + "Instance: domain")
   - To single line: "You are logged in as username@instance"
   - File: VoiceLinkApp.swift CommandMenu("Account") line 77-81

4. Sound Organization
   - Synced organized sound folders from source to Resources
   - Structure: sounds/ui-sounds/, sounds/actions/, sounds/ambience/
   - Updated AppSoundManager to check ui-sounds subfolder first
   - File: AppSoundManager.swift loadSound() method

BUILD INFO (Build 2):
- Size: 156,144,694 bytes (156 MB)
- SHA512: KTNK8gJZNrpd3EOV729xuYHcNmHO7wHn9Pn9CEaKgKGx6aPN1LroRoHc7pySmjfHaaqTbjm9qfR7kEmyNhNMLg==
- Build time: 87.87s
- Uploaded to both servers with updated latest-mac.yml

PENDING INVESTIGATION:
- Message sending functionality (reported not working - needs runtime testing)
- Action menus not working (needs runtime testing)
- These may require server connection or additional configuration

---
[2026-02-06 Build 4] - Audio Routing Fix (CRITICAL)

ROOT CAUSE IDENTIFIED:
- Server had NO socket handlers for audio relay (enable-audio-relay, audio-data, p2p-connection-failed)
- When P2P connections fail (common due to NAT/firewalls), there was no fallback
- Desktop app had no microphone capture/transmission code
- Desktop app had no handlers for receiving relayed audio

SERVER FIXES (local-server.js):
1. Added 'enable-audio-relay' handler - enables relay mode for user
2. Added 'audio-data' handler - relays audio to all users in same room
3. Added 'p2p-connection-failed' handler - notifies target to switch to relay
- File: source/server/routes/local-server.js (after line 693)
- Deployed to both Main Server and VPS, pm2 restarted

DESKTOP APP FIXES (Swift):
1. ServerManager.swift:
   - Added import AVFoundation
   - Added 'relayed-audio' socket handler - receives audio from server
   - Added 'audio-data' socket handler - alternative event name
   - Added 'relay-status' handler - tracks relay mode
   - Added 'p2p-fallback-needed' handler - auto-enables relay mode
   - Added startAudioTransmission() - captures mic via AVAudioEngine
   - Added stopAudioTransmission() - stops mic capture
   - Audio transmission starts on joinRoom(), stops on leaveRoom()
   - Mute/unmute controls start/stop transmission

2. SpatialAudioEngine.swift:
   - Added receiveAudioData(from:data:timestamp:sampleRate:) method
   - Creates AVAudioPlayerNode per remote user on demand
   - Converts base64 audio data to AVAudioPCMBuffer
   - Routes through spatial audio processing (3D positioning)
   - Schedules buffers for playback

3. VoiceLinkApp.swift (Build 3 changes also included):
   - Added context menus on UserRow (Whisper, DM, Send File, View Profile)
   - Added connection checks for message sending
   - TextField disabled when offline
   - Debug logging for message operations

AUDIO PIPELINE (NOW COMPLETE):
  Sender: Mic → AVAudioEngine → inputNode tap → base64 encode → socket.emit('audio-data')
  Server: socket.on('audio-data') → socket.to(roomId).emit('relayed-audio')
  Receiver: socket.on('relayed-audio') → base64 decode → SpatialAudioEngine.receiveAudioData()
           → AVAudioPlayerNode → AVAudioEnvironmentNode → speakers

WEB APP: Same server fix enables audio for web clients too since the
  webrtc-manager.js already had client-side relay code, it just needed
  the server handlers to relay the packets.

BUILD INFO (Build 4):
- Size: 362,666,533 bytes (346 MB)
- SHA512 (base64): 3CApqqS9Efn+jmajEfEVVkPI5pgpCXwiz6qojpu0r2lXDeFL+qRggQRXXSeMHZC/gQn99j5sV59LzXLqErkSnw==
- Build time: 99.82s
- Deployed to both servers

---
Claude TODO / Pending Tasks
- Test audio between two users in a room (desktop and web)
- Test P2P vs relay mode switching
- Test mute/unmute correctly starts/stops transmission
- Verify Settings -> Updates tab exists
- Confirm window close hides to menubar
- Resolve WHMCS SMTP credentials if needed
---
